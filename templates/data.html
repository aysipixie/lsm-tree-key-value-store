{% extends "base.html" %}

{% block title %}Data - LSM Key-Value Store{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-table me-2 text-primary"></i>
                Data Browser
            </h1>
            
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="{{ url_for('operations_page') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Add Data
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Data Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <div class="text-primary mb-2">
                    <i class="fas fa-database fa-2x"></i>
                </div>
                <h3 class="card-title" id="total-items">{{ items|length }}</h3>
                <p class="card-text text-muted">Total Items</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <div class="text-success mb-2">
                    <i class="fas fa-key fa-2x"></i>
                </div>
                <h3 class="card-title" id="unique-keys">{{ items|length }}</h3>
                <p class="card-text text-muted">Unique Keys</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <div class="text-info mb-2">
                    <i class="fas fa-filter fa-2x"></i>
                </div>
                <h3 class="card-title" id="filtered-items">{{ items|length }}</h3>
                <p class="card-text text-muted">Filtered Items</p>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>Search & Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="searchInput" class="form-label">Search Keys</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Type to search keys..." onkeyup="filterData()">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="keyTypeFilter" class="form-label">Key Type</label>
                        <select class="form-select" id="keyTypeFilter" onchange="filterData()">
                            <option value="">All Types</option>
                            <option value="user_">Users</option>
                            <option value="product_">Products</option>
                            <option value="config_">Configuration</option>
                            <option value="session_">Sessions</option>
                            <option value="demo_">Demo Data</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="sortOrder" class="form-label">Sort Order</label>
                        <select class="form-select" id="sortOrder" onchange="filterData()">
                            <option value="asc">A-Z</option>
                            <option value="desc">Z-A</option>
                        </select>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="exportData()">
                        <i class="fas fa-download me-1"></i>Export JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Data Items
                </h5>
                <small class="text-muted">
                    Showing <span id="showing-count">{{ items|length }}</span> of <span id="total-count">{{ items|length }}</span> items
                </small>
            </div>
            
            <div class="card-body p-0">
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width: 30%">Key</th>
                                <th style="width: 45%">Value</th>
                                <th style="width: 15%">Type</th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in items.items() %}
                            <tr data-key="{{ key }}">
                                <td>
                                    <code class="text-primary">{{ key }}</code>
                                </td>
                                <td>
                                    <div class="value-cell" style="max-height: 100px; overflow-y: auto;">
                                        <pre class="mb-0"><code>{{ value | tojson(2) }}</code></pre>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {% if value is mapping %}
                                        Object
                                        {% elif value is sequence and value is not string %}
                                        Array
                                        {% elif value is number %}
                                        Number
                                        {% elif value is boolean %}
                                        Boolean
                                        {% else %}
                                        String
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="viewItem('{{ key }}')" title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="editItem('{{ key }}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteItem('{{ key }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="text-muted mb-3">
                        <i class="fas fa-inbox fa-3x"></i>
                    </div>
                    <h5 class="text-muted">No data found</h5>
                    <p class="text-muted">Start by adding some key-value pairs or load sample data.</p>
                    <div class="mt-3">
                        <a href="{{ url_for('demo_page') }}" class="btn btn-primary me-2">
                            <i class="fas fa-play me-1"></i>Load Sample Data
                        </a>
                        <a href="{{ url_for('operations_page') }}" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Add Data
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>View Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Key:</label>
                    <div class="bg-light p-2 rounded">
                        <code id="view-key"></code>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Value:</label>
                    <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        <pre><code id="view-value"></code></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="editFromView()">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="edit-key" class="form-label">Key</label>
                        <input type="text" class="form-control" id="edit-key" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit-value" class="form-label">Value</label>
                        <textarea class="form-control" id="edit-value" rows="10"></textarea>
                        <div class="form-text">Enter JSON or plain text</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveEdit()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentData = {{ items | tojson }};
let currentEditKey = null;

function refreshData() {
    location.reload();
}

function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const keyType = document.getElementById('keyTypeFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    const tbody = document.querySelector('#dataTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    let visibleCount = 0;
    
    // Filter and sort
    const filteredRows = rows.filter(row => {
        const key = row.dataset.key;
        const matchesSearch = key.toLowerCase().includes(searchTerm);
        const matchesType = !keyType || key.startsWith(keyType);
        
        const isVisible = matchesSearch && matchesType;
        row.style.display = isVisible ? '' : 'none';
        
        if (isVisible) visibleCount++;
        
        return isVisible;
    });
    
    // Sort
    filteredRows.sort((a, b) => {
        const keyA = a.dataset.key;
        const keyB = b.dataset.key;
        
        if (sortOrder === 'desc') {
            return keyB.localeCompare(keyA);
        }
        return keyA.localeCompare(keyB);
    });
    
    // Reorder rows
    filteredRows.forEach(row => tbody.appendChild(row));
    
    // Update count
    document.getElementById('showing-count').textContent = visibleCount;
    document.getElementById('filtered-items').textContent = visibleCount;
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('keyTypeFilter').value = '';
    document.getElementById('sortOrder').value = 'asc';
    filterData();
}

function exportData() {
    const dataStr = JSON.stringify(currentData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `kv_store_export_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function viewItem(key) {
    document.getElementById('view-key').textContent = key;
    document.getElementById('view-value').textContent = JSON.stringify(currentData[key], null, 2);
    currentEditKey = key;
    
    const modal = new bootstrap.Modal(document.getElementById('viewModal'));
    modal.show();
}

function editItem(key) {
    currentEditKey = key;
    document.getElementById('edit-key').value = key;
    document.getElementById('edit-value').value = JSON.stringify(currentData[key], null, 2);
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

function editFromView() {
    const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewModal'));
    viewModal.hide();
    
    setTimeout(() => {
        editItem(currentEditKey);
    }, 200);
}

function saveEdit() {
    const key = document.getElementById('edit-key').value;
    const valueStr = document.getElementById('edit-value').value;
    
    let value;
    try {
        value = JSON.parse(valueStr);
    } catch (e) {
        value = valueStr; // Keep as string if not valid JSON
    }
    
    fetch('/api/put', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ key: key, value: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Item updated successfully!', 'success');
            
            // Update local data
            currentData[key] = value;
            
            // Update table row
            const row = document.querySelector(`tr[data-key="${key}"]`);
            if (row) {
                const valueCell = row.querySelector('.value-cell pre code');
                valueCell.textContent = JSON.stringify(value, null, 2);
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
        } else {
            showAlert('Error updating item: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
}

function deleteItem(key) {
    if (!confirm(`Are you sure you want to delete key '${key}'?`)) {
        return;
    }
    
    fetch(`/api/delete/${encodeURIComponent(key)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.deleted) {
            showAlert('Item deleted successfully!', 'success');
            
            // Remove from local data
            delete currentData[key];
            
            // Remove table row
            const row = document.querySelector(`tr[data-key="${key}"]`);
            if (row) {
                row.remove();
            }
            
            // Update counts
            const newCount = Object.keys(currentData).length;
            document.getElementById('total-items').textContent = newCount;
            document.getElementById('unique-keys').textContent = newCount;
            document.getElementById('total-count').textContent = newCount;
            
            filterData(); // Refresh filtered count
        } else {
            showAlert('Item not found or already deleted', 'warning');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
}

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    filterData();
});
</script>
{% endblock %}
