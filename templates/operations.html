{% extends "base.html" %}

{% block title %}Operations - LSM Key-Value Store{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tools me-2 text-primary"></i>
            CRUD Operations
        </h1>
    </div>
</div>

<!-- Operation Forms -->
<div class="row">
    <!-- Single Operations -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Single Operations
                </h5>
            </div>
            <div class="card-body">
                <!-- Put Operation -->
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-plus-circle me-1"></i>Put (Create/Update)
                    </h6>
                    <form id="putForm">
                        <div class="mb-3">
                            <label for="putKey" class="form-label">Key</label>
                            <input type="text" class="form-control" id="putKey" placeholder="Enter key" required>
                        </div>
                        <div class="mb-3">
                            <label for="putValue" class="form-label">Value</label>
                            <textarea class="form-control" id="putValue" rows="3" placeholder="Enter value (JSON or plain text)" required></textarea>
                            <div class="form-text">You can enter JSON objects, arrays, strings, or numbers</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Put
                        </button>
                    </form>
                </div>

                <hr>

                <!-- Get Operation -->
                <div class="mb-4">
                    <h6 class="text-info">
                        <i class="fas fa-search me-1"></i>Get (Read)
                    </h6>
                    <form id="getForm">
                        <div class="mb-3">
                            <label for="getKey" class="form-label">Key</label>
                            <input type="text" class="form-control" id="getKey" placeholder="Enter key to search" required>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-search me-1"></i>Get
                        </button>
                    </form>
                    <div id="getResult" class="mt-3"></div>
                </div>

                <hr>

                <!-- Delete Operation -->
                <div>
                    <h6 class="text-danger">
                        <i class="fas fa-trash me-1"></i>Delete
                    </h6>
                    <form id="deleteForm">
                        <div class="mb-3">
                            <label for="deleteKey" class="form-label">Key</label>
                            <input type="text" class="form-control" id="deleteKey" placeholder="Enter key to delete" required>
                        </div>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Operations -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>Batch Operations
                </h5>
            </div>
            <div class="card-body">
                <!-- Batch Put -->
                <div class="mb-4">
                    <h6 class="text-success">
                        <i class="fas fa-upload me-1"></i>Batch Put
                    </h6>
                    <form id="batchPutForm">
                        <div class="mb-3">
                            <label for="batchPutData" class="form-label">JSON Data</label>
                            <textarea class="form-control" id="batchPutData" rows="8" placeholder='{"key1": "value1", "key2": {"name": "John", "age": 30}}' required></textarea>
                            <div class="form-text">Enter a JSON object with key-value pairs</div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i>Batch Put
                        </button>
                    </form>
                </div>

                <hr>

                <!-- Batch Get -->
                <div class="mb-4">
                    <h6 class="text-warning">
                        <i class="fas fa-download me-1"></i>Batch Get
                    </h6>
                    <form id="batchGetForm">
                        <div class="mb-3">
                            <label for="batchGetKeys" class="form-label">Keys (comma-separated)</label>
                            <input type="text" class="form-control" id="batchGetKeys" placeholder="key1, key2, key3" required>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-download me-1"></i>Batch Get
                        </button>
                    </form>
                    <div id="batchGetResult" class="mt-3"></div>
                </div>

                <hr>

                <!-- Range Query -->
                <div>
                    <h6 class="text-secondary">
                        <i class="fas fa-filter me-1"></i>Range Query
                    </h6>
                    <form id="rangeForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rangeStart" class="form-label">Start Key (inclusive)</label>
                                <input type="text" class="form-control" id="rangeStart" placeholder="Optional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rangeEnd" class="form-label">End Key (exclusive)</label>
                                <input type="text" class="form-control" id="rangeEnd" placeholder="Optional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-filter me-1"></i>Query Range
                        </button>
                    </form>
                    <div id="rangeResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Area -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>Operation Results
                </h5>
            </div>
            <div class="card-body">
                <div id="operationResults">
                    <p class="text-muted">Operation results will appear here...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Utility function to display results
function displayResult(title, data, type = 'info') {
    const resultsDiv = document.getElementById('operationResults');
    const timestamp = new Date().toLocaleString();
    
    const resultHtml = `
        <div class="alert alert-${type} alert-dismissible fade show">
            <h6><i class="fas fa-info-circle me-1"></i>${title}</h6>
            <small class="text-muted">Timestamp: ${timestamp}</small>
            <pre class="mt-2 mb-0"><code>${JSON.stringify(data, null, 2)}</code></pre>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
}

// Put operation
document.getElementById('putForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const key = document.getElementById('putKey').value;
    const valueStr = document.getElementById('putValue').value;
    
    let value;
    try {
        value = JSON.parse(valueStr);
    } catch (e) {
        value = valueStr; // Keep as string if not valid JSON
    }
    
    fetch('/api/put', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ key: key, value: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResult(`Put Operation: ${key}`, data, 'success');
            document.getElementById('putForm').reset();
            showAlert('Key-value pair saved successfully!', 'success');
        } else {
            displayResult('Put Operation Failed', data, 'danger');
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});

// Get operation
document.getElementById('getForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const key = document.getElementById('getKey').value;
    
    fetch(`/api/get/${encodeURIComponent(key)}`)
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('getResult');
        
        if (data.success && data.exists) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Found:</strong>
                    <pre class="mt-2 mb-0"><code>${JSON.stringify(data.value, null, 2)}</code></pre>
                </div>
            `;
            displayResult(`Get Operation: ${key}`, data, 'info');
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Not Found:</strong> Key '${key}' does not exist.
                </div>
            `;
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});

// Delete operation
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const key = document.getElementById('deleteKey').value;
    
    if (!confirm(`Are you sure you want to delete key '${key}'?`)) {
        return;
    }
    
    fetch(`/api/delete/${encodeURIComponent(key)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.deleted) {
                displayResult(`Delete Operation: ${key}`, data, 'success');
                showAlert('Key deleted successfully!', 'success');
            } else {
                displayResult(`Delete Operation: ${key} (Not Found)`, data, 'warning');
                showAlert('Key was not found', 'warning');
            }
            document.getElementById('deleteForm').reset();
        } else {
            displayResult('Delete Operation Failed', data, 'danger');
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});

// Batch put operation
document.getElementById('batchPutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const dataStr = document.getElementById('batchPutData').value;
    
    let data;
    try {
        data = JSON.parse(dataStr);
    } catch (e) {
        showAlert('Invalid JSON format', 'danger');
        return;
    }
    
    fetch('/api/batch_put', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ items: data })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            displayResult(`Batch Put: ${result.successful}/${result.total} items`, result, 'success');
            showAlert(`Batch put completed: ${result.successful}/${result.total} items`, 'success');
            document.getElementById('batchPutForm').reset();
        } else {
            displayResult('Batch Put Failed', result, 'danger');
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});

// Batch get operation
document.getElementById('batchGetForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const keysStr = document.getElementById('batchGetKeys').value;
    const keys = keysStr.split(',').map(k => k.trim()).filter(k => k);
    
    fetch('/api/batch_put', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ keys: keys })
    })
    .then(response => {
        // Use individual get requests for batch get (simpler implementation)
        const promises = keys.map(key => 
            fetch(`/api/get/${encodeURIComponent(key)}`).then(r => r.json())
        );
        return Promise.all(promises);
    })
    .then(results => {
        const batchResult = {};
        results.forEach((result, index) => {
            batchResult[keys[index]] = result.exists ? result.value : null;
        });
        
        const resultDiv = document.getElementById('batchGetResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <strong>Batch Get Results:</strong>
                <pre class="mt-2 mb-0"><code>${JSON.stringify(batchResult, null, 2)}</code></pre>
            </div>
        `;
        
        displayResult(`Batch Get: ${keys.length} keys`, batchResult, 'info');
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});

// Range query
document.getElementById('rangeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const startKey = document.getElementById('rangeStart').value || undefined;
    const endKey = document.getElementById('rangeEnd').value || undefined;
    
    const params = new URLSearchParams();
    if (startKey) params.set('start', startKey);
    if (endKey) params.set('end', endKey);
    
    fetch(`/api/range?${params}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const resultDiv = document.getElementById('rangeResult');
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>Range Query Results (${data.count} items):</strong>
                    <pre class="mt-2 mb-0"><code>${JSON.stringify(data.data, null, 2)}</code></pre>
                </div>
            `;
            
            displayResult(`Range Query: ${data.count} items`, data, 'info');
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
});
</script>
{% endblock %}
